<!DOCTYPE html>
<html>

<head>
    {% load static %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="{% static 'app/css/styles.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
</head>

<body>
    {% include 'app/navbar.html' %}

    <div class="row mx-5 my-5">
        <div class="col-sm-2"></div>
        <div class="col-sm-8">
            <h1>Your Services</h1>
            <hr style="border-color: #DDD; width: 100%">
            <table class="table table-hover">
                <thead class="thead-light">
                    <tr>
                        <th scope="col">Name</th>
                        <th scope="col">Description</th>
                        <th scope="col">Cost</th>
                        <th scope="col">Image</th>
                        <th scope="col">Edit</th>
                    </tr>
                </thead>
                <tbody>
                    {% for service in service_list %}
                    <tr>
                        <td class="align-middle">{{ service.name }}</td>
                        <td class="align-middle">{{ service.description }}</td>
                        <td class="align-middle">{{ service.price }} ALGO</td>
                        <td class="align-middle">{{ service.image_path }}</td>
                        <td class="align-middle">
                            <button
                                type="button"
                                class="btn btn-primary"
                                data-toggle="modal"
                                data-target="#editServiceModal"
                                data-service-name="{{ service.name }}"
                                data-service-description="{{ service.description }}"
                                data-service-price="{{ service.price }}"
                                data-service-id="{{ service.id }}"
                                >
                                Edit
                        </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <a class="btn btn-primary" href="{% url 'settings' %}">&#x0003C;&#x0003C; Return to Settings</a>
            <button type="button" class="btn btn-success" data-toggle="modal" data-target="#newServiceModal"
                data-backdrop="static" data-keyboard="false">Create New Service +</button>
        </div>
        <div class="col-sm-2"></div>
    </div>
    <div class="modal fade" id="newServiceModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newServiceModalLabel">Create New Service</h5>
                </div>
                <form method="POST" action="/services">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-4 d-flex align-items-center">
                                <label class="m-0" for="createName">Name:</label>
                            </div>
                            <div class="col-md-8">
                                <input class="form-control" id="createName" type="text" name="name" required />
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 d-flex align-items-center">
                                <label class="m-0" for="createDescription">Description:</label>
                            </div>
                            <div class="col-md-8">
                                <textarea class="form-control" id="createDescription" rows="5" name="description" required></textarea>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 d-flex align-items-center">
                                <label class="m-0" for="createPrice">Price:</label>
                            </div>
                            <div class="col-md-5">
                                <input class="form-control" id="createPrice" type="number" name="price" required />
                            </div>
                            <div class="col-md-3 d-flex align-items-center p-0">
                                <label class="m-0" for="createPrice">ALGO</label>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 d-flex align-items-center">
                                <label class="m-0" for="createImage">Image:</label>
                            </div>
                            <div class="col-md-8">
                                <input class="form-control-file" id="createImage" type="file">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="editServiceModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editServiceModalLabel">Edit Service</h5>
                </div>
                <form>
                    {% csrf_token %}
                    <input id="updateServiceID" type="hidden" name="serviceID" />
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-4 d-flex align-items-center">
                                <label class="m-0" for="updateName">Name:</label>
                            </div>
                            <div class="col-md-8">
                                <input class="form-control" id="updateName" type="text" name="name" required />
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 d-flex align-items-center">
                                <label class="m-0" for="updateDescription">Description:</label>
                            </div>
                            <div class="col-md-8">
                                <textarea class="form-control" id="updateDescription" rows="5" name="description" required></textarea>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 d-flex align-items-center">
                                <label class="m-0" for="updatePrice">Price:</label>
                            </div>
                            <div class="col-md-5">
                                <input class="form-control" id="updatePrice" type="number" name="price" required />
                            </div>
                            <div class="col-md-3 d-flex align-items-center p-0">
                                <label class="m-0" for="updatePrice">ALGO</label>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 d-flex align-items-center">
                                <label class="m-0" for="updateImage">Image:</label>
                            </div>
                            <div class="col-md-8">
                                <input class="form-control-file" id="updateImage" type="file">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onClick="updateService()">Update</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        // script to get the correct data in the edit service modal depending on which service is being edited
        $('#editServiceModal').on('show.bs.modal', function (event) {
            let button = $(event.relatedTarget) // Button that triggered the modal
            let name = button.data('service-name')
            let description = button.data('service-description')
            let price = button.data('service-price')
            let id = button.data('service-id')
            let modal = $(this)
            modal.find('#updateName').val(name)
            modal.find('#updateDescription').val(description)
            modal.find('#updatePrice').val(price)
            modal.find('#updateServiceID').val(id)
        })
    </script>
    <script>
        //function to get the CSRF-token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        //script to send a PUT request for updating a service in the database
        async function updateService() {
            let data = {
                'id': $('#updateServiceID').val(),
                'name': $('#updateName').val(),
                'description': $('#updateDescription').val(),
                'price': $('#updatePrice').val()
            }
            const response = await fetch('/services', {
                method: 'PUT',
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                body: JSON.stringify(data)
            })
        }
    </script>
</body>

</html>